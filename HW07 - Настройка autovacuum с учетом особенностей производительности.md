<b>Домашнее задание 07: Настройка autovacuum с учетом особенностей производительности</b>

Цель:
<br>запустить нагрузочный тест pgbench
<br>настроить параметры autovacuum
<br>проверить работу autovacuum

Описание/Пошаговая инструкция выполнения домашнего задания:
<br>Создать инстанс ВМ с 2 ядрами и 4 Гб ОЗУ и SSD 10GB
<br>Установить на него PostgreSQL 15 с дефолтными настройками
<br>Создать БД для тестов: выполнить pgbench -i postgres
<br>Запустить pgbench -c8 -P 6 -T 60 -U postgres postgres
<br>Применить параметры настройки PostgreSQL из прикрепленного к материалам занятия файла
<br>Протестировать заново
<br>Что изменилось и почему?
<br>Создать таблицу с текстовым полем и заполнить случайными или сгенерированными данным в размере 1млн строк
<br>Посмотреть размер файла с таблицей
<br>5 раз обновить все строчки и добавить к каждой строчке любой символ
<br>Посмотреть количество мертвых строчек в таблице и когда последний раз приходил автовакуум
<br>Подождать некоторое время, проверяя, пришел ли автовакуум
<br>5 раз обновить все строчки и добавить к каждой строчке любой символ
<br>Посмотреть размер файла с таблицей
<br>Отключить Автовакуум на конкретной таблице
<br>10 раз обновить все строчки и добавить к каждой строчке любой символ
<br>Посмотреть размер файла с таблицей
<br>Объясните полученный результат
<br>Не забудьте включить автовакуум)


# Выполнение
<br>Подключились к ВМ с Postgresql, созданной в VirtualBox:
<br>ssh -p 3022 yuriy@127.0.0.1

<br>Проверка:
<br>pgbench --version
![01 Подключились к ВМ с Postgresql](https://github.com/user-attachments/assets/78a65f21-b998-4094-9f0a-a55eccff42e6)


<br>Инициализация теста pgbench:
<br>pgbench -U postgres -h 0.0.0.0 -i TestVacuum
![02 Инициализация теста pgbench](https://github.com/user-attachments/assets/00a49700-7636-42fe-842d-f137edd7e4c8)


<br>Запуск:
<br>pgbench -c8 -P 6 -T 60 -U postgres TestVacuum
![03 Запуск теста](https://github.com/user-attachments/assets/483f3967-de4a-49ad-a2ff-bb526a958110)

<br>Из задания:
<br>Применить параметры настройки PostgreSQL из прикрепленного к материалам занятия файла
<br>Протестировать заново
<br>Что изменилось и почему?

<br>Изменил настройки в файле postgresql.conf:
<br>sudo nano /etc/postgresql/16/main/postgresql.conf
![05 поменял настройки в postgresql conf](https://github.com/user-attachments/assets/dae66668-5a1f-4c35-9d4a-a703eb2f685d)

<br>Проверка применения настроек
![06 проверка смены настроек](https://github.com/user-attachments/assets/16dacea2-f07e-45de-bc3e-e646db61a987)


<br>Повторный запуск теста после смены настроек:
<br>pgbench -c8 -P 6 -T 60 -U postgres TestVacuum
![07 повторный запуск теста после смены настроек](https://github.com/user-attachments/assets/33f71dfa-72b0-4dc2-a813-d5d16a723511)

<br><b>Ответ: Особых изменений не произошло. Возможно из-за того, что в базе нет тяжёлых объектов.</b>
<br>Было:
<br>latency average = 35.061 ms
<br>latency stddev = 22.617 ms
<br>initial connection time = 139.067 ms
<br><b>tps = 227.850168 (without initial connection time)</b>

<br>Стало:
<br>latency average = 34.900 ms
<br>latency stddev = 22.020 ms
<br>initial connection time = 146.991 ms
<br><b>tps = 228.889880 (without initial connection time)</b>

<br>Далее по заданию:
<br>Создать таблицу с текстовым полем и заполнить случайными или сгенерированными данным в размере 1млн строк
<br>Посмотреть размер файла с таблицей
<br>5 раз обновить все строчки и добавить к каждой строчке любой символ
<br><b>Посмотреть количество мертвых строчек в таблице и когда последний раз приходил автовакуум</b>
<br>Подождать некоторое время, проверяя, пришел ли автовакуум
![08_1 выполнение заданий1 До вакуум](https://github.com/user-attachments/assets/cab645ac-40cc-4fc1-b782-5cba04a29e22)

<br><b>После того как пришел автовакуум, мёртвых строчек не осталось</b>
![08_2 выполнение заданий - прошёл autovacuum](https://github.com/user-attachments/assets/a19469fa-fe38-40a4-a8d5-cafa2338ce4d)


<br>5 раз обновить все строчки и добавить к каждой строчке любой символ
<br>Посмотреть размер файла с таблицей
<br><b>Размер файла таблицы увеличился с 35МБ до 207МБ</b>
![08_3 Размер таблицы 2](https://github.com/user-attachments/assets/e2a9e9df-3c9a-4914-8e01-dad23fbfdb87)

<br><b>После выполнения vacuum full. Мёртвые строки удалились и размер файла таблицы стал снова 35МБ</b>
<br>vacuum full test;
![08_4 Размер таблицы 2 после выполнения vacuum full](https://github.com/user-attachments/assets/aeb5118c-dcad-41c3-8828-2ceb094d3db7)


<br>Далее по заданию:
<br>Отключить Автовакуум на конкретной таблице
<br>10 раз обновить все строчки и добавить к каждой строчке любой символ
<br>Посмотреть размер файла с таблицей
<br>Объясните полученный результат
<br>Не забудьте включить автовакуум)

<br><b>Выполнение:</b>
<br>Автовакуум отключен на новыой таблице vtest и произведено заполнение таблицы значениями
<br>Размер файла таблицы: 64МБ
<br>Затем 10 раз обновлены все строчки таблицы и добавлены к каждой строчке символы '_a'
<br><b>Размер файла таблицы вырос с 64МБ до 448МБ. Произошло из-за того, что не произведено удаление мёртвых строчек таблицы и они продолжают занимать место на диске</b>
![09_2 Отключить Автовакуум на конкретной таблице](https://github.com/user-attachments/assets/c6888b5e-b905-4c87-8f9b-9b788b4526ae)


<br>После включения автовакуум-а на таблице vtest:
<br>ALTER TABLE vtest SET (autovacuum_enabled = on);
<br>vacuum full vtest;
<br><b>Размер файла таблицы стал прежним: 64МБ, т.к. из таблицы прошло удаление мёртвых строчек.</b>
![09_3 После включения autovacuum_enabled](https://github.com/user-attachments/assets/f086ca90-10bb-40e4-b50f-5abeeb1e86aa)


